name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    if: |
      github.actor != 'claude[bot]' &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add in-progress label
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request == null
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "ready-to-process" \
            --add-label "in-progress" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Create PR if branch exists but no PR
        if: success() && github.event_name == 'issue_comment' && github.event.issue.pull_request == null
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}

          # Fetch all remote branches
          git fetch origin

          # Check if a branch was created for this issue
          BRANCH=$(git branch -r --list "origin/claude/issue-${ISSUE_NUM}-*" | head -1 | sed 's/.*origin\///' | xargs)

          if [ -z "$BRANCH" ]; then
            echo "No branch found for issue #$ISSUE_NUM"
            exit 0
          fi

          echo "Found branch: $BRANCH"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH"
            PR_URL=$(gh pr view "$EXISTING_PR" --json url --jq '.url')
          else
            echo "Creating PR for branch $BRANCH"
            ISSUE_TITLE=$(gh issue view "$ISSUE_NUM" --json title --jq '.title')

            # Create PR and capture any errors
            PR_OUTPUT=$(gh pr create \
              --head "$BRANCH" \
              --base main \
              --title "$ISSUE_TITLE" \
              --body "Closes #$ISSUE_NUM" 2>&1) || true

            echo "PR creation output: $PR_OUTPUT"

            # Extract URL if PR was created
            if echo "$PR_OUTPUT" | grep -q "github.com"; then
              PR_URL=$(echo "$PR_OUTPUT" | grep -o 'https://github.com[^ ]*')
              echo "Created PR: $PR_URL"
            else
              echo "Failed to create PR: $PR_OUTPUT"
              exit 0
            fi
          fi

          # Merge PR using PAT to trigger dependency-tracker workflow
          if [ -n "$PR_URL" ]; then
            echo "Merging PR: $PR_URL"
            GH_TOKEN="${{ secrets.PAT_TOKEN }}" gh pr merge "$PR_URL" --squash --delete-branch || echo "Merge failed or already merged"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}